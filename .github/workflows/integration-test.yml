name: Integration Tests

on:
  push:
    branches:
      - main
      - master

env:
  R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
  R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
  R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
  R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
  TEST_FILE_NAME: ${{ secrets.TEST_FILE_NAME }}

jobs:
  integration-test:
    name: Integration Tests (Kind)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Setup Kind
        uses: helm/kind-action@v1
        with:
          cluster_name: file-caching-test
          wait: 60s

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.13.0'

      - name: Build and load image into Kind
        run: make kind-load-image

      - name: Deploy with Helm
        run: make kind-deploy

      - name: Wait for pods to be ready
        run: |
          echo "Waiting for pods to be ready..."
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=file-caching-service -n default --timeout=180s
          echo "=== Pod Status ==="
          kubectl get pods -n default
          echo "=== Pod Logs ==="
          kubectl logs -l app.kubernetes.io/name=file-caching-service --tail=30 || true

      - name: Run integration tests
        run: |
          # Get the pod name
          POD_NAME=$(kubectl get pod -l app.kubernetes.io/name=file-caching-service -n default -o jsonpath='{.items[0].metadata.name}')
          echo "Found pod: $POD_NAME"
          
          # Start port-forward to pod directly (port 8080 inside container)
          kubectl port-forward pod/$POD_NAME 8080:8080 &
          PF_PID=$!
          sleep 5
          
          # Verify service is ready
          echo "Verifying service is ready..."
          for i in {1..30}; do
            RESPONSE=$(curl -s http://localhost:8080/health || echo "connection_failed")
            if echo "$RESPONSE" | grep -q "success"; then
              echo "Service is ready!"
              break
            fi
            
            if [ $i -eq 30 ]; then
              echo "Service failed to become ready"
              echo "=== Pod logs ==="
              kubectl logs $POD_NAME --tail=100
              echo "=== Pod describe ==="
              kubectl describe pod $POD_NAME
              kill $PF_PID 2>/dev/null || true
              exit 1
            fi
            echo "Waiting for service... attempt $i"
            sleep 2
          done
          
          # Run tests
          SERVICE_URL=http://localhost:8080 TEST_FILE_NAME=$TEST_FILE_NAME go test -v ./tests/integration/... -timeout 5m
          TEST_EXIT=$?
          
          # Cleanup
          kill $PF_PID 2>/dev/null || true
          exit $TEST_EXIT

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Application Logs ==="
          kubectl logs -l app.kubernetes.io/name=file-caching-service --tail=100
          echo ""
          echo "=== Redis Logs ==="
          kubectl logs -l app.kubernetes.io/component=redis --tail=50
          echo ""
          echo "=== Pod Status ==="
          kubectl get pods -o wide
          echo ""
          echo "=== Pod Descriptions ==="
          kubectl describe pods

      - name: Cleanup
        if: always()
        run: make kind-delete
